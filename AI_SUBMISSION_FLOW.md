# AI-Powered Grievance Submission Flow

## Overview
This document describes the enhanced grievance submission flow that uses OpenAI to automatically generate tags and provide knowledge base suggestions before final submission.

## Flow Diagram

```
User fills form → Submit (preview mode) → AI generates tags + KB suggestions 
    ↓
Preview Page (shows AI tags + KB suggestions)
    ↓
User reviews → Confirm Submission (saves to database) → Dashboard
```

## Backend Implementation

### 1. New Functions in `utils.py`

#### `generate_tags_with_ai(title: str, description: str) -> List[str]`
- **Purpose**: Automatically generates 3-5 relevant tags for a grievance using OpenAI
- **Input**: Grievance title and description
- **Output**: List of lowercase tags (e.g., ["library", "ac_issue", "urgent"])
- **Fallback**: Returns ["general", "unclassified"] if OpenAI is unavailable
- **Model**: Uses ChatGPT (configured in settings.openai.chat_model)
- **Temperature**: 0.3 (for consistency)

#### `get_kb_suggestions_for_grievance(description: str, top_k: int = 3) -> List[Dict]`
- **Purpose**: Finds relevant knowledge base chunks similar to the grievance description
- **Process**:
  1. Generates embedding for the grievance description
  2. Searches MongoDB kb_chunks collection using cosine similarity
  3. Returns top K most similar chunks
- **Output**: List of suggestions with doc_name, excerpt, similarity_score, chunk_id

#### `MongoRepository.search_similar_chunks(query_embedding: List[float], top_k: int) -> List[Dict]`
- **Purpose**: Search KB chunks using cosine similarity
- **Algorithm**: 
  - Calculates cosine similarity between query embedding and all chunk embeddings
  - Formula: `cosine_similarity = dot_product / (magnitude_query * magnitude_chunk)`
  - Sorts by similarity score (descending)
- **Returns**: Top K most similar chunks with their metadata

### 2. Modified Endpoint: `POST /grievances`

#### New Parameter: `preview` (boolean)
- **preview=true**: Returns AI-generated data without saving to database
- **preview=false**: Saves grievance to database (final submission)

#### Preview Mode Response
```json
{
  "preview": true,
  "grievance": {
    "title": "Library AC Not Working",
    "description": "...",
    "status": "NEW",
    "assigned_to": "OTHERS",
    "tags": ["library", "ac_issue", "urgent"],
    "cluster": null,
    "cluster_tags": []
  },
  "ai_generated_tags": ["library", "ac_issue", "urgent"],
  "kb_suggestions": [
    {
      "doc_name": "AC Maintenance Guide.pdf",
      "excerpt": "For AC issues in library...",
      "similarity_score": 0.89,
      "chunk_id": "abc123"
    }
  ],
  "documents": [...]
}
```

#### Normal Mode Response (preview=false)
```json
{
  "grievance": {
    "id": 42,
    "title": "Library AC Not Working",
    "description": "...",
    "status": "NEW",
    "assigned_to": "OTHERS",
    "tags": ["library", "ac_issue", "urgent"],
    ...
  }
}
```

## Frontend Implementation

### 1. Modified: `SubmitGrievance.tsx`

#### Changes to `handleSubmit`:
1. Sets `preview: true` in the API request
2. Calls `submitGrievance()` with preview mode enabled
3. Navigates to `/user/preview` with response data in location state
4. Shows toast: "AI is generating tags and finding relevant suggestions..."

#### Navigation with State
```typescript
setLocation('/user/preview', { 
  state: { previewData: response } 
});
```

### 2. Rewritten: `GrievancePreview.tsx`

#### New Features:
1. **Receives preview data from location state**
   - Accesses via `window.history.state.state.previewData`
   - Redirects to submit page if no data present

2. **Displays AI-Generated Tags**
   - Shows tags with animated badges
   - Tags are auto-generated by OpenAI based on content
   - Visual indicator with Sparkles icon

3. **Displays KB Suggestions**
   - Shows top 3 most relevant knowledge base chunks
   - Each suggestion includes:
     - Document name
     - Excerpt (first 300 characters)
     - Similarity score as percentage
   - Animated entry with stagger effect

4. **User Actions**:
   - **"Back to Edit"**: Returns to submission form
   - **"Confirm & Submit"**: Submits grievance with AI tags (preview=false)

#### Final Submission Logic
```typescript
const finalData = {
  ...previewData.grievance,
  issue_tags: previewData.ai_generated_tags, // Use AI tags
  documents: previewData.documents,
  preview: false, // Final submission
};
```

## User Experience Flow

### Step 1: Fill Submission Form
- User fills title, description, optional fields
- User can optionally add their own tags (will be overridden by AI)

### Step 2: Initial Submit (Preview Mode)
- Click "Submit Grievance" button
- Backend:
  - OpenAI analyzes title + description
  - Generates 3-5 relevant tags
  - Searches KB for similar content
  - Returns preview data (NOT saved to DB)
- Frontend:
  - Shows loading toast
  - Navigates to preview page

### Step 3: Review Preview
- User sees:
  - **Grievance details** (title, description, department)
  - **AI-generated tags** with sparkles icon
  - **KB suggestions** with similarity scores
  - **Uploaded documents** (if any)

### Step 4: Make Decision
- **Option A: Back to Edit**
  - Returns to submission form
  - Can modify and resubmit
  
- **Option B: Confirm & Submit**
  - Submits to backend with preview=false
  - Saves to database with AI-generated tags
  - Shows success message
  - Redirects to dashboard

## Benefits

### 1. Automatic Tag Generation
- **Consistency**: AI ensures standardized tagging
- **Accuracy**: Tags are contextually relevant
- **Time-saving**: Users don't need to manually categorize

### 2. Knowledge Base Suggestions
- **Self-service**: Users might find solutions in KB
- **Reduced tickets**: Similar issues may already be documented
- **Better informed**: Users understand their issue better

### 3. Two-stage Submission
- **Review opportunity**: Users can verify AI-generated data
- **Flexibility**: Can go back and edit if needed
- **Transparency**: Users see how AI interpreted their issue

## Technical Details

### OpenAI Integration
- **Embedding Model**: text-embedding-ada-002 (configured in settings)
- **Chat Model**: gpt-3.5-turbo or gpt-4 (configured in settings)
- **API Key**: Configured in `settings.openai.api_key`

### MongoDB Collections
- **kb_chunks**: Stores knowledge base document chunks with embeddings
  - Fields: doc_id, chunk_id, text, embedding, doc_name, folder_id
  - Index: Compound unique index on (doc_id, chunk_id)

### Error Handling
- **OpenAI unavailable**: Falls back to generic tags ["general", "unclassified"]
- **KB empty**: Shows message "No similar content found"
- **MongoDB errors**: Logs warning, returns empty suggestions
- **Frontend errors**: Shows toast notification, allows retry

## Configuration

### Required Environment Variables
```bash
OPENAI_API_KEY=sk-...
OPENAI_EMBEDDING_MODEL=text-embedding-ada-002
OPENAI_CHAT_MODEL=gpt-3.5-turbo
MONGO_URI=mongodb://localhost:27017
MONGO_DB_NAME=grievances_db
MONGO_KB_COLLECTION=kb_chunks
```

### Settings (config.py)
```python
class OpenAISettings:
    api_key: str
    embedding_model: str = "text-embedding-ada-002"
    chat_model: str = "gpt-3.5-turbo"

class MongoSettings:
    uri: str
    db_name: str
    kb_collection: str = "kb_chunks"
```

## Testing

### Backend Testing
```bash
# Test preview mode (without saving)
curl -X POST http://localhost:5000/grievances \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Library AC Not Working",
    "description": "The AC has been broken for a week",
    "preview": true
  }'

# Test final submission
curl -X POST http://localhost:5000/grievances \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Library AC Not Working",
    "description": "The AC has been broken for a week",
    "issue_tags": ["library", "ac_issue"],
    "preview": false
  }'
```

### Frontend Testing
1. Navigate to `/user/submit`
2. Fill form with test data
3. Click "Submit Grievance"
4. Verify preview page loads with AI tags and KB suggestions
5. Click "Confirm & Submit"
6. Verify grievance appears in dashboard

## Maintenance

### Adding More KB Documents
1. Register Google Drive folder via admin panel
2. Upload documents to GDrive folder
3. System automatically:
   - Downloads documents
   - Chunks them
   - Generates embeddings
   - Stores in MongoDB kb_chunks

### Updating AI Prompts
- Modify prompt in `generate_tags_with_ai()` function
- Test with various grievance types
- Adjust temperature for consistency vs creativity

### Monitoring
- Check backend logs for OpenAI API errors
- Monitor token usage via OpenAI dashboard
- Track KB suggestion relevance scores
- Monitor user behavior (accept/edit AI tags)

## Future Enhancements

### Potential Improvements
1. **Allow users to edit AI tags before confirming**
2. **Add "Mark as Resolved" button on preview if KB suggestion solves issue**
3. **Track which KB suggestions are most helpful**
4. **Use user feedback to retrain/improve tag generation**
5. **Add semantic search for related grievances**
6. **Generate suggested solutions from KB content**

### Performance Optimizations
1. **Cache embeddings** for common grievance types
2. **Batch OpenAI requests** for multiple grievances
3. **Use MongoDB vector search** (Atlas) for faster similarity search
4. **Implement pagination** for KB suggestions
